<div class="w3-section">
  <h1 class="ms-font-rubik ms-color-2b" style="font-size:1.5em;">
    <mat-icon style="vertical-align:middle; font-size: 30px; width:30px; height: 30px">repeat</mat-icon> Rehaceres
  </h1>
  <mat-tab-group animationDuration="500ms" [selectedIndex]="currentTab.value"
    (selectedIndexChange)="currentTab.setValue($event)">
    <mat-tab>
      <ng-template mat-tab-label>
        <span [matBadge]="dbs.qualityRedosReports.length" matBadgeColor="warn"
        [matBadgeHidden]="dbs.qualityRedosReports.length === 0" matBadgeOverlap="false">Reportes</span>
      </ng-template>
      <ng-template matTabContent>
        <div class="w3-padding" style="overflow-y:hidden">
          <h2 class="ms-font-rubik ms-color-2b" style="font-size:1.2em">Reportar</h2>

          <div>
            <button mat-raised-button color="primary" class="w3-margin-right" (click)="createReport()">
              <mat-icon>add_circle</mat-icon> Agregar
            </button>

            <mat-form-field class="w3-margin-right">
              <input matInput [matDatepicker]="dateFilter" [formControl]="monthFormControl">
              <mat-datepicker-toggle matSuffix [for]="dateFilter"></mat-datepicker-toggle>
              <mat-datepicker #dateFilter startView='year' (monthSelected)="setMonthOfView($event, dateFilter)"
                disabled="false"></mat-datepicker>
              <mat-hint>
                <strong>Filtrar contenido por mes y año</strong>
              </mat-hint>
            </mat-form-field>
          </div>

          <div>
            <div style="display:flex">
              <h2 class="ms-font-rubik ms-color-2b w3-margin-right" style="font-size:1.3em;">{{currentMonth}}</h2>
              <button mat-button disabled="true" class="ms-color-2b">
                <mat-icon>assignment_turned_in</mat-icon> {{dbs.qualityRedosReports.length | number: '2.0'}} Documentos
              </button>
            </div>

            <div class="mat-elevation-z8 w3-margin-top w3-round-large w3-hide-small">
              <div class="w3-amber w3-round-large" style="overflow:auto">
                <table mat-table [dataSource]="dataSourceRedosReports" matSort style="width:100%">

                  <ng-container matColumnDef="index">
                    <th mat-header-cell *matHeaderCellDef style="background:#eaeaea;padding: 0px 1em 0px 1em">N°</th>
                    <td mat-cell *matCellDef="let report; let i = index"
                      style="color:#2b2b2b; padding: 0px 1em 0px 1em">
                      {{i+1}}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fecha</th>
                    <td mat-cell *matCellDef="let report" class="w3-center"
                      style="color:#2b2b2b; padding:0px 1em 0px 1em; border-left:1px solid lightgrey">
                      <span class="w3-small"
                        style="font-weight:500">{{report['regDate'] | date : 'dd/MM/yyyy'}}</span><br>
                      <span class="w3-small">({{report['regDate'] | date : 'hh:mm:ss'}})</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="createdBy">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; min-width:200px; border-left:1px solid lightgrey">
                      Creado por</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; min-width:200px; border-left:1px solid lightgrey">
                      <span class="w3-small" style="font-weight:500">{{report['createdBy']['displayName']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Area: {{report['createdBy']['area']['name']}}</li>
                      </ul>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="OT">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      OT</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      <span class="w3-small">{{report['OT']}}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="area">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; min-width:200px; border-left:1px solid lightgrey">
                      Área</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; min-width:200px; border-left:1px solid lightgrey">
                      <span class="w3-small" style="font-weight:500">{{report['area']['name']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Sup.: {{report['area']['supervisor']['displayName']}}</li>
                      </ul>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="description">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      Descripción</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      <span class="w3-small">{{report['description']}}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="component">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      Componente</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      <span class="w3-small">{{report['component']}}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      Estado</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; min-width:230px; border-left:1px solid lightgrey">
                      <span class="ms-chip" [ngClass]="{'w3-green':report['status']==='Finalizado', 'w3-amber':report['status']==='Por confirmar', 'w3-indigo':report['status']==='Confirmado', 'w3-red':report['status']==='Rechazado'}">
                        {{report['status']}}
                      </span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="initialPicture">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; border-left:1px solid lightgrey">Foto inicial
                    </th>
                    <td mat-cell *matCellDef="let report" class="w3-center"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; border-left:1px solid lightgrey">
                      <a href="{{report['initialPicture']}}" target="_blank"
                        *ngIf="report['initialPicture']; else defaultPictureTable1">
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="{{report['initialPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                        </div>
                      </a>
                      <ng-template #defaultPictureTable1>
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                            class="w3-card-4">
                        </div>
                      </ng-template>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="edit" stickyEnd>
                    <th mat-header-cell *matHeaderCellDef
                      style="background:#eaeaea;padding:0px 1.5em 0px 1em; border-left:1px solid lightgrey">
                      Acciones</th>
                    <td mat-cell *matCellDef="let report"
                      style="color:#2b2b2b; padding:0px 1.5em 0px 1em; border-left:1px solid lightgrey">
                      <button mat-icon-button color="primary" matTooltip="Analizar" (click)="nextStageAnalyze(report)"
                        [disabled]="report['stage'] != 'Reporte' || report['status'] === 'Por confirmar' || report['status'] === 'Rechazado' || !isTechnician">
                        <mat-icon>next_week</mat-icon>
                      </button><br>
                      <button mat-icon-button color="primary" matTooltip="Editar reporte" (click)="editReport(report)">
                        <mat-icon>edit</mat-icon>
                      </button><br>
                      <button mat-icon-button color="warn" matTooltip="Borrar reporte"
                        (click)="deleteReport(report['id'],report['uidSupervisor'])">
                        <mat-icon>delete</mat-icon>
                      </button><br>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumnsReports; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumnsReports;"></tr>

                </table>
              </div>
              <mat-paginator class="w3-round-large" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons>
              </mat-paginator>
            </div>

            <!-- MOBIL VERSION REPORTS-->
            <div class="w3-hide-large w3-hide-medium w3-margin-top">
              <ng-container *ngFor="let report of dbs.currentDataQualityRedosReports | async; let i = index">
                <div [@openCloseCard]="isOpenReport[i] ? 'open': 'closed'" (click)="toggleCardReport(i)"
                  class="mat-elevation-z8 ms-hero-image w3-display-container w3-round-large"
                  [ngStyle]="{'background-image': report['initialPicture'] ? ('url(' + report['initialPicture'] + ')') : 'url(../../../assets/images/no-image-mobile.jpeg)'}">

                  <div class="w3-display-bottomleft w3-padding w3-round-large"
                    style="background:rgba(0,0,0,0.2); width:100%; height:100%">
                    <div style="display:flex">
                      <p style="font-weight:600; color:white; margin: 0.5em 0.1em">
                        <span class="w3-round-large"
                          style="background: rgba(255,255,255,0.2); padding:4px 12px; margin-right:8px">{{i +1}}</span>
                        {{report['OT']}}
                      </p>
                      <span class="ms-fill"></span>
                      <button mat-icon-button class="w3-text-white" matTooltip="Analizar"
                        (click)="nextStageAnalyze(report)"
                        [disabled]="report['stage'] != 'Reporte' || report['status'] === 'Por confirmar' || report['status'] === 'Rechazado' || !isTechnician">
                        <mat-icon>next_week</mat-icon>
                      </button>

                      <button mat-icon-button class="w3-text-white" matTooltip="Borrar reporte"
                        (click)="deleteReport(report['id'], report['uidSupervisor'])">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>

                    <mat-divider class="w3-white" style="margin:0.5em 0em"></mat-divider>
                    <p style="font-weight:400; color:white; margin: 0px 0.1em">
                      {{report['area']['name']}}
                    </p>
                    <p style="font-weight:400; color:white; margin: 0px 0.1em">
                      {{report['component']}}
                    </p>

                    <div style="display:flex; justify-content: space-between">
                      <span style="padding:8px 0px; font-size:0.9em; color: white" matTooltip="Fecha de reporte"
                        *ngIf="report['regDate'] > 0">
                        {{(report['regDate']) | date: 'dd/MM/yyyy'}}</span>
                      <span class="ms-fill"></span>
                      <span class="w3-padding w3-round-large" style="font-size:0.9em; font-weight:600"
                        [ngClass]="{'w3-red':report['status'] === 'Rechazado', 'w3-green':report['status'] === 'Confirmado', 'w3-amber':report['status'] === 'Por confirmar'}"
                        matTooltip="Estado">
                        {{report['status']}}</span>
                    </div>
                  </div>

                </div>

                <div [@openCloseContent]="isOpenReport[i] ? 'openContent': 'closedContent'" class="mat-elevation-z8">
                  <mat-toolbar style="background:#333333">
                    <span class="ms-font-raleway ms-color-wt" style="font-weight:500">Detalles</span>
                    <span class="ms-fill"></span>
                    <button mat-icon-button class="w3-text-white" matTooltip="Editar reporte"
                      (click)="editReport(report)">
                      <mat-icon>edit</mat-icon>
                    </button>
                  </mat-toolbar>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">Fecha</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span>{{report['regDate'] | date : 'dd/MM/yyy'}}</span><br>
                      <span class="w3-small">{{report['regDate'] | date : 'hh:mm:ss'}}</span>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                    <div class="w3-col s6 ms-header-mobile">Creado por</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span class="w3-small" style="font-weight:500">{{report['createdBy']['displayName']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Area: {{report['createdBy']['area']['name']}}</li>
                      </ul>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">OT</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span class="w3-small">{{report['OT']}}</span>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">Área</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span class="w3-small" style="font-weight:500">{{report['area']['name']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Sup.: {{report['area']['supervisor']['displayName']}}</li>
                      </ul>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">Descripción</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span class="w3-small">{{report['description']}}</span>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">Componente</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span class="w3-small">{{report['component']}}</span>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">Estado</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <span class="ms-chip" [ngClass]="{'w3-green':report['status']==='Finalizado', 'w3-amber':report['status']==='Por confirmar', 'w3-indigo':report['status']==='Confirmado', 'w3-red':report['status']==='Rechazado'}">
                        {{report['status']}}
                      </span>
                    </div>
                  </div>
                  <div class="w3-row w3-border-bottom w3-border-lightgray">
                    <div class="w3-col s6 ms-header-mobile">Imagen inicial</div>
                    <div class="w3-col s6" style="padding: 0.5em 0.5em">
                      <a class="w3-medium" target="_blank" [href]="report['initialPicture']"
                        *ngIf="report['initialPicture']; else noImageLink">Ver imagen</a>
                      <ng-template #noImageLink>
                        <span class="w3-small w3-text-gray">No disponible</span>
                      </ng-template>
                    </div>
                  </div>
                  <mat-toolbar>
                    <span class="ms-fill"></span>
                    <button mat-icon-button matTooltip="Cerrar" (click)="toggleCardReport(i)">
                      <mat-icon>keyboard_arrow_up</mat-icon>
                    </button>
                  </mat-toolbar>
                </div>
              </ng-container>
            </div>
          </div>


        </div>
      </ng-template>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <span [matBadge]="dbs.qualityRedosAnalyze.length" matBadgeColor="warn"
        [matBadgeHidden]="dbs.qualityRedosAnalyze.length === 0" matBadgeOverlap="false">Análisis</span>
      </ng-template>
      <ng-template matTabContent>
        <div class="w3-padding" style="overflow-y:hidden">
          <h2 class="ms-font-rubik ms-color-2b" style="font-size:1.2em">Análisis</h2>

          <mat-form-field class="w3-margin-right">
            <input matInput [matDatepicker]="dateFilter" [formControl]="monthFormControl">
            <mat-datepicker-toggle matSuffix [for]="dateFilter"></mat-datepicker-toggle>
            <mat-datepicker #dateFilter startView='year' (monthSelected)="setMonthOfView($event, dateFilter)"
              disabled="false"></mat-datepicker>
            <mat-hint>
              <strong>Filtrar contenido por mes y año</strong>
            </mat-hint>
          </mat-form-field>

          <div style="display:flex">
            <h2 class="ms-font-rubik ms-color-2b w3-margin-right" style="font-size:1.3em;">{{currentMonth}}</h2>
            <button mat-button disabled="true" class="ms-color-2b">
              <mat-icon>assignment_turned_in</mat-icon> {{dbs.qualityRedosAnalyze.length | number: '2.0'}} Documentos
            </button>
          </div>

          <div *ngFor="let analyze of dbs.currentDataQualityRedosAnalyze | async; let i = index" class="w3-hide-small">
            <div [@openClosePanel]="isOpenAnalyze[i] ? 'openPanel': 'closedPanel'"
              class="w3-block w3-round-large mat-elevation-z4 w3-margin-top w3-white w3-hover-shadow w3-hover-lightgray"
              style="z-index:1; position:relative" (click)="togglePanelAnalyze(i, analyze)">

              <div class="w3-row w3-border-bottom w3-border-lightgray ms-font-roboto ms-color-bt">
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">N°</span><br>
                  <span>{{i+1 | number : '2.'}}</span>
                </div>
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">Fecha</span><br>
                  <span>{{analyze['regDate'] | date: 'dd/MM/yyyy'}}</span>
                </div>
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">OT</span><br>
                  <span>{{analyze['OT']}}</span>
                </div>
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">Área</span><br>
                  <span>{{analyze['area']['name']}}</span>
                </div>
                <div class="w3-col m4 w3-padding-large">
                  <span style="font-weight:600">Descripción</span><br>
                  <span style="font-size:14px">{{analyze['description']}}</span>
                </div>
              </div>
            </div>

            <mat-toolbar [@openCloseToolbar]="isOpenAnalyze[i] ? 'openToolbar': 'closedToolbar'"
              style="background:#191919" class="ms-color-2b">
              <button mat-raised-button color="primary" class="w3-margin-right" matTooltip="Agregar acciones"
                (click)="nextStageActions(analyze)" [disabled]="!isTechnician">
                <mat-icon class="example-icon">next_week</mat-icon> Acciones
              </button>
              <button mat-raised-button class="w3-margin-right" matTooltip="Editar análisis"
                (click)="editAnalyze(analyze)">
                <mat-icon class="example-icon">edit</mat-icon> Editar
              </button>
              <button mat-raised-button class="w3-margin-right" matTooltip="Borrar análisis"
                (click)="deleteAnalyze(analyze)">
                <mat-icon class="example-icon">delete</mat-icon> Borrar
              </button>
            </mat-toolbar>

            <div [@openCloseTable]="isOpenAnalyze[i] ? 'openTable': 'closedTable'" class="w3-amber"
              style="overflow:auto">
              <table mat-table [dataSource]="dataSourceRedosAnalyzePanel" matSort style="width:100%">

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="redoType">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Tipo de Rehacer
                  </th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['redoType']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="component">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Componente</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['component']}}
                  </td>
                </ng-container>

                <!-- <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="OTSegment">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">OT / Segmento
                    Rehacer</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['OTSegment']}}
                  </td>
                </ng-container> -->

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="customer">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Cliente</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['customer']['fullName']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="repairType">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Tipo de
                    reparación</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['repairType']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="hours">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Horas</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['hours']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="failureMode">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Modo de Falla
                  </th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['failureMode']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="rootCause">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Causa raíz</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['rootCause']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="involvedAreas">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Áreas
                    responsables</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <ng-container *ngFor="let area of row['involvedAreas']">
                      <span class="w3-small" style="font-weight:500">{{area['name']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Sup.: {{area['supervisor']['displayName']}}</li>
                      </ul>
                    </ng-container>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo"
                  matColumnDef="responsibleStaff">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Personal
                    responsable</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <ng-container *ngFor="let staff of row['responsibleStaff']">
                      <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Sup.: {{staff['jobTitle']}}</li>
                      </ul>
                    </ng-container>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="pictures">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fotos</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <a target="_blank" (click)="openPictures(row)"
                      *ngIf="row['initialPicture']; else defaultPictureTable1">
                      <div class="w3-display-container" style="width:200px;height:120px;padding:6px 6px">
                        <img src="{{row['initialPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                        <div class="w3-display-middle w3-round-large"
                          style="background: rgba(0,0,0,0.7);padding:0.5em 0.5em;">
                          <span style="color:white; font-size:2em; font-weight:600">
                            <mat-icon style="vertical-align:middle">add</mat-icon> {{row['pictureCounter']}}
                          </span>
                        </div>
                      </div>
                    </a>
                    <ng-template #defaultPictureTable1>
                      <div style="width:200px;height:120px;padding:6px 6px">
                        <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                          class="w3-card-4">
                      </div>
                    </ng-template>
                  </td>
                </ng-container>


                <tr mat-header-row *matHeaderRowDef="displayedColumnsAnalyze; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsAnalyze;"></tr>

              </table>
            </div>
          </div>

          <!-- MOBIL VERSION ANALYZE-->
          <div class="w3-hide-large w3-hide-medium w3-margin-top">
            <ng-container *ngFor="let analyze of dbs.currentDataQualityRedosAnalyze | async; let i = index">
              <div [@openClosePanelMobile]="isOpenAnalyze[i] ? 'openPanelMobile': 'closedPanelMobile'"
                (click)="togglePanelAnalyze(i, analyze)"
                class="mat-elevation-z8 ms-hero-image w3-display-container w3-round-large"
                [ngStyle]="{'background-image': analyze['initialPicture'] ? ('url(' + analyze['initialPicture'] + ')') : 'url(../../../assets/images/no-image-mobile.jpeg)'}">

                <div class="w3-display-bottomleft w3-padding w3-round-large"
                  style="background:rgba(0,0,0,0.2); width:100%; height:100%">
                  <div style="display:flex">
                    <p style="font-weight:600; color:white; margin: 0.5em 0.1em">
                      <span class="w3-round-large"
                        style="background: rgba(255,255,255,0.2); padding:4px 12px; margin-right:8px">{{i +1}}</span>
                      {{analyze['OT']}}
                    </p>
                    <span class="ms-fill"></span>
                    <button mat-icon-button class="w3-text-white" matTooltip="Proponer acciones"
                      (click)="nextStageActions(analyze)"
                      [disabled]="analyze['stage'] != 'Analizar' || analyze['status'] === 'Por confirmar'  || !isTechnician">
                      <mat-icon>next_week</mat-icon>
                    </button>
                    <button mat-icon-button class="w3-text-white" matTooltip="Borrar análisis"
                      (click)="deleteAlyze(analyze)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>

                  <mat-divider class="w3-white" style="margin:0.5em 0em"></mat-divider>
                  <p style="font-weight:400; color:white; margin: 0px 0.1em">
                    {{analyze['area']['name']}}
                  </p>
                  <p style="font-weight:400; color:white; margin: 0px 0.1em">
                    {{analyze['component']}}
                  </p>

                  <div style="display:flex; justify-content: space-between">
                    <span style="padding:8px 0px; font-size:0.9em; color: white" matTooltip="Fecha de reporte"
                      *ngIf="analyze['regDate'] > 0">
                      {{(analyze['regDate']) | date: 'dd/MM/yyyy'}}</span>
                    <span class="ms-fill"></span>
                    <span class="w3-padding w3-round-large w3-center" style="font-size:0.9em; font-weight:500"
                      [ngClass]="{'w3-red':analyze['status'] === 'Rechazado', 'w3-green':analyze['status'] === 'Confirmado', 'w3-amber':analyze['status'] === 'Por confirmar'}"
                      matTooltip="Fecha de análisis">
                      <span>Análisis</span><br>
                      <span>{{analyze['analyzeDate'] | date: 'dd/MM/yyyy' }}</span>

                    </span>
                  </div>
                </div>

              </div>

              <div [@openCloseContent]="isOpenAnalyze[i] ? 'openContent': 'closedContent'" class="mat-elevation-z8"
                style="min-height:560px">
                <mat-tab-group animation="500ms" [selectedIndex]="currentAnalyzeTab.value"
                  (selectedIndexChange)="currentAnalyzeTab.setValue($event)">
                  <mat-tab label="Reporte">
                    <mat-toolbar style="background: #333333">
                      <span class="ms-font-raleway ms-color-wt" style="font-weight:500">Detalles</span>
                      <span class="ms-fill"></span>
                      <button mat-icon-button class="w3-text-white" matTooltip="Editar reporte"
                        (click)="editReport(analyze)">
                        <mat-icon>edit</mat-icon>
                      </button>
                    </mat-toolbar>

                    <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                      <div class="w3-col s6 ms-header-mobile">Fecha</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span>{{analyze['regDate'] | date : 'dd/MM/yyy'}}</span><br>
                        <span class="w3-small">{{analyze['regDate'] | date : 'hh:mm:ss'}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Creado por</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small" style="font-weight:500">{{analyze['createdBy']['displayName']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">Area: {{analyze['createdBy']['area']['name']}}</li>
                        </ul>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">OT</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['OT']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Área</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small" style="font-weight:500">{{analyze['area']['name']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">Sup.: {{analyze['area']['supervisor']['displayName']}}</li>
                        </ul>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Descripción</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['description']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Componente</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['component']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Estado</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['status']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Imagen inicial</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <a class="w3-medium" target="_blank" [href]="analyze['initialPicture']"
                          *ngIf="analyze['initialPicture']; else noImageLink">Ver imagen</a>
                        <ng-template #noImageLink>
                          <span class="w3-small w3-text-gray">No disponible</span>
                        </ng-template>
                      </div>
                    </div>
                  </mat-tab>

                  <mat-tab label="Análisis">
                    <mat-toolbar style="background: #333333">
                      <span class="ms-font-raleway ms-color-wt" style="font-weight:500">Detalles</span>
                      <span class="ms-fill"></span>
                      <button mat-icon-button class="w3-text-white" matTooltip="Editar análisis"
                        (click)="editAnalyze(analyze)">
                        <mat-icon>edit</mat-icon>
                      </button>
                    </mat-toolbar>

                    <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                      <div class="w3-col s6 ms-header-mobile">Tipo de rehacer</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span>{{analyze['redoType']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                      <div class="w3-col s6 ms-header-mobile">Componente</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['component']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">OT</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['OT']}}</span>
                      </div>
                    </div>
                    <!-- <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">OT / Segmento de rehacer</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['OTSegment']}}</span>
                      </div>
                    </div> -->
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Cliente</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['customer']['fullName']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Tipo de reparación</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['repairType']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Horas</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['hours']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Causa raíz</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['rootCause']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Clasificación de la causa</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['causeClassification']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Áreas responsables</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <ng-container *ngFor="let area of analyze['involvedAreas']">
                          <span class="w3-small" style="font-weight:500">{{area['name']}}</span>
                          <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                            <li class="w3-small">Sup.: {{area['supervisor']['displayName']}}</li>
                          </ul>
                        </ng-container>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Personal responsable</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <ng-container *ngFor="let staff of analyze['responsibleStaff']">
                          <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                          <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                            <li class="w3-small">Sup.: {{staff['jobTitle']}}</li>
                          </ul>
                        </ng-container>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Fotos</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <a target="_blank" (click)="openPictures(analyze)"
                          *ngIf="analyze['initialPicture']; else defaultPictureTable1">
                          <div class="w3-display-container" style="width:150px;height:90px;padding:6px 6px">
                            <img src="{{analyze['initialPicture']}}" style="max-width:100%;height:100%"
                              class="w3-card-4">
                            <div class="w3-display-middle w3-round-large"
                              style="background: rgba(0,0,0,0.7);padding:0.5em 0.5em;">
                              <span style="color:white; font-size:2em; font-weight:600">
                                <mat-icon style="vertical-align:middle">add</mat-icon> {{analyze['pictureCounter']}}
                              </span>
                            </div>
                          </div>
                        </a>
                        <ng-template #defaultPictureTable1>
                          <div style="width:150px;height:90px;padding:6px 6px">
                            <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                              class="w3-card-4">
                          </div>
                        </ng-template>
                      </div>
                    </div>

                  </mat-tab>
                </mat-tab-group>
                <mat-toolbar>
                  <span class="ms-fill"></span>
                  <button mat-icon-button matTooltip="Cerrar" (click)="toggleCardAnalyze(i)">
                    <mat-icon>keyboard_arrow_up</mat-icon>
                  </button>
                </mat-toolbar>
              </div>


            </ng-container>
          </div>

        </div>
      </ng-template>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <span [matBadge]="dbs.qualityRedosActions.length" matBadgeColor="warn"
        [matBadgeHidden]="dbs.qualityRedosActions.length === 0" matBadgeOverlap="false">Acciones</span>
      </ng-template>
      <ng-template matTabContent>
        <div class="w3-padding" style="overflow-y:hidden">
          <h2 class="ms-font-rubik ms-color-2b" style="font-size:1.2em">Acciones</h2>

          <mat-form-field class="w3-margin-right">
            <input matInput [matDatepicker]="dateFilter" [formControl]="monthFormControl">
            <mat-datepicker-toggle matSuffix [for]="dateFilter"></mat-datepicker-toggle>
            <mat-datepicker #dateFilter startView='year' (monthSelected)="setMonthOfView($event, dateFilter)"
              disabled="false"></mat-datepicker>
            <mat-hint>
              <strong>Filtrar contenido por mes y año</strong>
            </mat-hint>
          </mat-form-field>

          <div style="display:flex">
            <h2 class="ms-font-rubik ms-color-2b w3-margin-right" style="font-size:1.3em;">{{currentMonth}}</h2>
            <button mat-button disabled="true" class="ms-color-2b">
              <mat-icon>assignment_turned_in</mat-icon> {{dbs.qualityRedosActions.length | number: '2.0'}} Documentos
            </button>
          </div>



          <div *ngFor="let document of dbs.currentDataQualityRedosActions | async; let i = index"
            class="w3-hide-small mat-elevation-z8 w3-round-large">
            <div [@openClosePanel]="isOpenActions[i] ? 'openPanel': 'closedPanel'"
              class="w3-block w3-round-large w3-margin-top w3-white w3-hover-shadow w3-hover-lightgray"
              style="z-index:1; position:relative" (click)="togglePanelActions(i, document)">

              <div class="w3-row w3-border-bottom w3-border-lightgray ms-font-roboto ms-color-bt">
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">N°</span><br>
                  <span>{{i+1 | number : '2.'}}</span>
                </div>
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">Fecha</span><br>
                  <span>{{document['regDate'] | date: 'dd/MM/yyyy'}}</span>
                </div>
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">OT</span><br>
                  <span>{{document['OT']}}</span>
                </div>
                <div class="w3-col m2 w3-padding-large">
                  <span style="font-weight:600">Área</span><br>
                  <span>{{document['OT']}}</span>
                </div>
                <div class="w3-col m4 w3-padding-large">
                  <span style="font-weight:600">Descripción</span><br>
                  <span style="font-size:14px">{{document['description']}}</span>
                </div>
              </div>
            </div>

            <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" class="w3-amber"
              style="overflow:auto">
              <table mat-table [dataSource]="dataSourceRedosActionsPanel" matSort style="width:100%">

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="redoType">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Tipo de Rehacer
                  </th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['redoType']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="component">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Componente</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['component']}}
                  </td>
                </ng-container>

                <!-- <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="OTSegment">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">OT / Segmento
                    Rehacer</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['OTSegment']}}
                  </td>
                </ng-container> -->

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="customer">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Cliente</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['customer']['fullName']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="repairType">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Tipo de
                    reparación</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['repairType']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="hours">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Horas</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['hours']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="failureMode">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Modo de Falla
                  </th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['failureMode']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="rootCause">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Causa raíz</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['rootCause']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="involvedAreas">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Áreas
                    responsables</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <ng-container *ngFor="let area of row['involvedAreas']">
                      <span class="w3-small" style="font-weight:500">{{area['name']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Sup.: {{area['supervisor']['displayName']}}</li>
                      </ul>
                    </ng-container>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo"
                  matColumnDef="responsibleStaff">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Personal
                    responsable</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <ng-container *ngFor="let staff of row['responsibleStaff']">
                      <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">Sup.: {{staff['jobTitle']}}</li>
                      </ul>
                    </ng-container>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="pictures">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fotos</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <a target="_blank" (click)="openPictures(row)"
                      *ngIf="row['initialPicture']; else defaultPictureTable1">
                      <div class="w3-display-container" style="width:200px;height:120px;padding:6px 6px">
                        <img src="{{row['initialPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                        <div class="w3-display-middle w3-round-large"
                          style="background: rgba(0,0,0,0.7);padding:0.5em 0.5em;">
                          <span style="color:white; font-size:2em; font-weight:600">
                            <mat-icon style="vertical-align:middle">add</mat-icon> {{row['pictureCounter']}}
                          </span>
                        </div>
                      </div>
                    </a>
                    <ng-template #defaultPictureTable1>
                      <div style="width:200px;height:120px;padding:6px 6px">
                        <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                          class="w3-card-4">
                      </div>
                    </ng-template>
                  </td>
                </ng-container>


                <tr mat-header-row *matHeaderRowDef="displayedColumnsAnalyze; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsAnalyze;"></tr>

              </table>
            </div>

            <div [@openCloseToolbar]="isOpenActions[i] ? 'openToolbar': 'closedToolbar'" style="background:#191919">
              <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em">
                <button mat-raised-button color="primary" class="w3-margin-right w3-text-white" matTooltip="Agregar acciones"
                  (click)="addActions(document)" [disabled]="!isTechnician">
                  <mat-icon class="example-icon">add_circle</mat-icon> Proponer acciones
                </button>
                <button mat-raised-button color="primary" class="w3-margin-right w3-text-white" matTooltip=""
                  (click)="approveActions(document)" [disabled]="this.selection.selected.length === 0 || !isQualitySupervisor">
                  <mat-icon>check_circle</mat-icon> Aprobar acciones
                </button>
                <div>
                  <ul style="margin-top:0.5em">
                    <li class="ms-color-wt w3-small">
                      Solo serán aprobadas las acciones seleccionadas (Este proceso no puede ser revertido)
                    </li>
                    <li class="ms-color-wt w3-small">
                      Al aprobar una acción, se enviarán notificaciones al responsable y personal adicional
                    </li>
                  </ul>
                </div>
              </div>

            </div>

            <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" style="overflow:auto">
              <table mat-table [dataSource]="dataSourceRedosActionsList" matSort style="width:100%">

                <!-- Checkbox Column -->
                <ng-container matColumnDef="select">
                  <th mat-header-cell *matHeaderCellDef
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">
                    <mat-checkbox *ngIf="actionsNotApproved" (change)="$event ? masterToggle() : null"
                      [checked]="selection.hasValue() && isAllSelected()"
                      [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
                    </mat-checkbox>
                  </th>
                  <td mat-cell *matCellDef="let row"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <mat-checkbox *ngIf="!row['approved']" (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null"
                      [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)">
                    </mat-checkbox>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">N°
                  </th>
                  <td mat-cell *matCellDef="let row; let i = index" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{i+1}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Acción</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    {{row['action']}}
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="approved">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Estado (Acción)</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <span class="ms-chip" [ngClass]="{'w3-green':row['approved'], 'w3-amber':!row['approved']}">{{row['approved']?'Acción aprobada':'Por aprobar'}}</span>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="responsibles">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Responsables</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <ng-container *ngFor="let staff of row['actionResponsibles']">
                      <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                      <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                        <li class="w3-small">{{staff['jobTitle']}}</li>
                      </ul>
                    </ng-container>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="finalPicture">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Foto final</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <div class="ms-gallery-container">
                      <a href="{{row['finalPicture']}}" target="_blank"
                      *ngIf="row['finalPicture']; else defaultPictureAction">
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="{{row['finalPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                        </div>
                      </a>
                      <ng-template #defaultPictureAction>
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                            class="w3-card-4">
                        </div>
                      </ng-template>
                      <a href="{{row['finalPicture2']}}" target="_blank"
                      *ngIf="row['finalPicture2']">
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="{{row['finalPicture2']}}" style="max-width:100%;height:100%" class="w3-card-4">
                        </div>
                      </a>
                      <a href="{{row['finalPicture3']}}" target="_blank"
                      *ngIf="row['finalPictur3']">
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="{{row['finalPictur3']}}" style="max-width:100%;height:100%" class="w3-card-4">
                        </div>
                      </a>
                    </div>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Estado (Tarea)</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <span class="ms-chip" [ngClass]="{'w3-green':row['status']==='Finalizado', 'w3-amber':row['status']==='Por confirmar', 'w3-indigo':row['status']==='Confirmado', 'w3-red':row['status']==='Rechazado'}">
                      {{row['approved']?row['status']:'***'}}
                    </span>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="realTerminationDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fecha de finalización</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <div *ngIf="row['realTerminationDate'] != 0">
                      <span>{{row['realTerminationDate'] | date : 'dd/MM/yyy'}}</span><br>
                      <span class="w3-small">{{row['realTerminationDate'] | date : 'hh:mm:ss'}}</span>
                    </div>
                    <div *ngIf="row['realTerminationDate'] === 0">
                      <span>{{'**/**/**'}}</span><br>
                      <span class="w3-small">{{'**:**:**'}}</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="finalArchive">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Archivo</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <a href="{{row['finalArchive']}}" target="_blank"
                    *ngIf="row['finalArchive']; else defaultPictureAction">
                      PDF
                    </a>
                    <ng-template #defaultPictureAction>
                      ***
                    </ng-template>
                    <a href="{{row['finalArchive2']}}" target="_blank"
                      *ngIf="row['finalArchive2']">
                      PDF
                    </a>
                    <a href="{{row['finalArchive3']}}" target="_blank"
                      *ngIf="row['finalArchive3']">
                      PDF
                    </a>
                  </td>
                </ng-container>

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="valid">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Validar tarea</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <button mat-raised-button color="primary" matTooltip="Validar el cumplimiento de la tarea"
                      (click)="validateAction(row, document)"
                      [disabled]="row['status'] != 'Finalizado' || !row['approved'] || !isQualitySupervisor"
                      *ngIf="!row['valid']">
                      <mat-icon>check_circle</mat-icon> Validar
                    </button><br>
                    <button mat-raised-button color="warn" matTooltip="Validar el cumplimiento de la tarea"
                      (click)="resetAction(row, document)"
                      [disabled]="row['status'] != 'Finalizado' || !row['approved'] || !isQualitySupervisor"
                      *ngIf="row['valid']">
                      <mat-icon>settings_backup_restore</mat-icon> Restaurar tarea
                    </button><br>
                  </td>
                </ng-container>
                

                <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="delete">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header
                    style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Borrar</th>
                  <td mat-cell *matCellDef="let row" class="w3-small"
                    style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                    <button mat-icon-button color="warn" matTooltip="Borrar acción propuesta"
                      (click)="deleteAction(row, document)" [disabled]="!isTechnician">
                      <mat-icon>delete</mat-icon>
                    </button><br>
                  </td>
                </ng-container>


                <tr mat-header-row *matHeaderRowDef="displayedColumnsActionsList; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsActionsList;"></tr>

              </table>
            </div>

            <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" style="background:#191919">
              <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em">
                <p class="w3-margin-bottom"> </p>
                <button mat-raised-button color="primary" class="w3-margin-right w3-margin-bottom w3-text-white" [matTooltip]="allValidated?'Solicitar cierre de documento':'Necesita que todas las tareas esten validadas para poder hacer una solicitud de cierre'"
                  (click)="requestClosing(document)" [disabled]="!allValidated || !isQualitySupervisor">
                  <mat-icon class="example-icon">forward</mat-icon> Solicitar cierre
                </button>
                <div>
                  <ul style="margin-top:0.5em">
                    <li class="ms-color-wt w3-small">
                      Se enviarán notificaciones a todos los responsables para que confirmen el cierre del rehacer
                    </li>
                    <li class="ms-color-wt w3-small">
                      Después de que todos los responsables hayan confirmado, se habilitará el botón de cierre y pasará a la lista de cerrados
                    </li>
                  </ul>
                </div>
                
              </div>
            </div>

          </div>

          <!-- MOBIL VERSION ACTIONS-->
          <div class="w3-hide-large w3-hide-medium w3-margin-top">
            <ng-container *ngFor="let analyze of dbs.currentDataQualityRedosActions | async; let i = index">
              <div [@openClosePanelMobile]="isOpenActions[i] ? 'openPanelMobile': 'closedPanelMobile'"
                (click)="togglePanelActions(i, analyze)"
                class="mat-elevation-z8 ms-hero-image w3-display-container w3-round-large"
                [ngStyle]="{'background-image': analyze['initialPicture'] ? ('url(' + analyze['initialPicture'] + ')') : 'url(../../../assets/images/no-image-mobile.jpeg)'}">

                <div class="w3-display-bottomleft w3-padding w3-round-large"
                  style="background:rgba(0,0,0,0.2); width:100%; height:100%">
                  <div style="display:flex">
                    <p style="font-weight:600; color:white; margin: 0.5em 0.1em">
                      <span class="w3-round-large"
                        style="background: rgba(255,255,255,0.2); padding:4px 12px; margin-right:8px">{{i +1}}</span>
                      {{analyze['OT']}}
                    </p>
                    <span class="ms-fill"></span>
                    <button mat-icon-button class="w3-text-white" matTooltip="Proponer acciones"
                      (click)="nextStageClose(analyze)"
                      [disabled]="analyze['stage'] != 'Acciones' || analyze['status'] === 'Por confirmar'">
                      <mat-icon>next_week</mat-icon>
                    </button>
                    <button mat-icon-button class="w3-text-white" matTooltip="Borrar rehacer"
                      (click)="deleteActions(analyze)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>

                  <mat-divider class="w3-white" style="margin:0.5em 0em"></mat-divider>
                  <p style="font-weight:400; color:white; margin: 0px 0.1em">
                    {{analyze['area']['name']}}
                  </p>
                  <p style="font-weight:400; color:white; margin: 0px 0.1em">
                    {{analyze['component']}}
                  </p>

                  <div style="display:flex; justify-content: space-between">
                    <span style="padding:8px 0px; font-size:0.9em; color: white" matTooltip="Fecha de reporte"
                      *ngIf="analyze['regDate'] > 0">
                      {{(analyze['regDate']) | date: 'dd/MM/yyyy'}}</span>
                    <span class="ms-fill"></span>
                    <span class="w3-padding w3-round-large w3-center" style="font-size:0.9em; font-weight:500"
                      [ngClass]="{'w3-red':analyze['status'] === 'Rechazado', 'w3-green':analyze['status'] === 'Confirmado', 'w3-amber':analyze['status'] === 'Por confirmar'}"
                      matTooltip="Fecha de análisis">
                      <span>Acciones</span><br>
                      <span>{{analyze['actionsDate'] | date: 'dd/MM/yyyy' }}</span>

                    </span>
                  </div>
                </div>

              </div>

              <div [@openCloseContent]="isOpenActions[i] ? 'openContent': 'closedContent'" class="mat-elevation-z8"
                style="min-height:560px">
                <mat-tab-group animation="500ms" [selectedIndex]="currentActionsTab.value"
                  (selectedIndexChange)="currentActionsTab.setValue($event)">

                  <mat-tab label="Reporte">
                    <mat-toolbar style="background: #333333">
                      <span class="ms-font-raleway ms-color-wt" style="font-weight:500; margin-bottom:0.5em; font-size:1.5em; width:100%">Reporte</span>
                      <span class="ms-fill"></span>
                    </mat-toolbar>

                    <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                      <div class="w3-col s6 ms-header-mobile">Fecha</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span>{{analyze['regDate'] | date : 'dd/MM/yyy'}}</span><br>
                        <span class="w3-small">{{analyze['regDate'] | date : 'hh:mm:ss'}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Creado por</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small" style="font-weight:500">{{analyze['createdBy']['displayName']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">Area: {{analyze['createdBy']['area']['name']}}</li>
                        </ul>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">OT</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['OT']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Área</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small" style="font-weight:500">{{analyze['area']['name']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">Sup.: {{analyze['area']['supervisor']['displayName']}}</li>
                        </ul>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Descripción</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['description']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Componente</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['component']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Estado</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['status']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Imagen inicial</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <a class="w3-medium" target="_blank" [href]="analyze['initialPicture']"
                          *ngIf="analyze['initialPicture']; else noImageLink">Ver imagen</a>
                        <ng-template #noImageLink>
                          <span class="w3-small w3-text-gray">No disponible</span>
                        </ng-template>
                      </div>
                    </div>
                  </mat-tab>

                  <mat-tab label="Análisis">
                    <mat-toolbar style="background: #333333">
                      <span class="ms-font-raleway ms-color-wt" style="font-weight:500; margin-bottom:0.5em; font-size:1.5em; width:100%">Análisis</span>
                      <span class="ms-fill"></span>
                    </mat-toolbar>

                    <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                      <div class="w3-col s6 ms-header-mobile">Tipo de rehacer</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span>{{analyze['redoType']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                      <div class="w3-col s6 ms-header-mobile">Componente</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['component']}}</span>
                      </div>
                    </div>
                    <!-- <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">OT / Segmento de rehacer</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['OTSegment']}}</span>
                      </div>
                    </div> -->
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Cliente</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['customer']['fullName']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Tipo de reparación</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['repairType']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Horas</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['hours']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Modo de falla</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['failureMode']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Causa raíz</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <span class="w3-small">{{analyze['rootCause']}}</span>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Áreas responsables</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <ng-container *ngFor="let area of analyze['involvedAreas']">
                          <span class="w3-small" style="font-weight:500">{{area['name']}}</span>
                          <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                            <li class="w3-small">Sup.: {{area['supervisor']['displayName']}}</li>
                          </ul>
                        </ng-container>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Personal responsable</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <ng-container *ngFor="let staff of analyze['responsibleStaff']">
                          <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                          <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                            <li class="w3-small">Sup.: {{staff['jobTitle']}}</li>
                          </ul>
                        </ng-container>
                      </div>
                    </div>
                    <div class="w3-row w3-border-bottom w3-border-lightgray">
                      <div class="w3-col s6 ms-header-mobile">Fotos</div>
                      <div class="w3-col s6" style="padding: 0.5em 0.5em">
                        <a target="_blank" (click)="openPictures(analyze)"
                          *ngIf="analyze['initialPicture']; else defaultPictureTable1">
                          <div class="w3-display-container" style="width:150px;height:90px;padding:6px 6px">
                            <img src="{{analyze['initialPicture']}}" style="max-width:100%;height:100%"
                              class="w3-card-4">
                            <div class="w3-display-middle w3-round-large"
                              style="background: rgba(0,0,0,0.7);padding:0.5em 0.5em;">
                              <span style="color:white; font-size:2em; font-weight:600">
                                <mat-icon style="vertical-align:middle">add</mat-icon> {{analyze['pictureCounter']}}
                              </span>
                            </div>
                          </div>
                        </a>
                        <ng-template #defaultPictureTable1>
                          <div style="width:150px;height:90px;padding:6px 6px">
                            <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                              class="w3-card-4">
                          </div>
                        </ng-template>
                      </div>
                    </div>

                  </mat-tab>

                  <mat-tab label="Acciones">
                    <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em; background:#191919">
                      <span class="ms-font-raleway ms-color-wt w3-margin-bottom" style="font-weight:500; margin-bottom:0.5em; font-size:1.5em; width:100%">Acciones</span><br>  
                      <button mat-raised-button color="primary" class="w3-margin-right; w3-margin-bottom w3-text-white" matTooltip="Agregar acciones"
                        (click)="addActions(analyze)">
                        <mat-icon class="example-icon">add_circle</mat-icon> Proponer acciones
                      </button>
                      <button mat-raised-button color="primary" class="w3-margin-right w3-text-white" matTooltip="Aprovar acciones seleccionadas"
                        (click)="approveActions(analyze)" [ngStyle]="{'color:lightslategray':this.selection.selected.length === 0}" [disabled]="this.selection.selected.length === 0 || !isQualitySupervisor">
                        <mat-icon>check_circle</mat-icon> Aprobar acciones
                      </button>
                      <div>
                        <ul style="margin-top:0.5em">
                          <li class="ms-color-wt w3-small">
                            Solo serán aprobadas las acciones seleccionadas (Este proceso no puede ser revertido)
                          </li>
                          <li class="ms-color-wt w3-small">
                            Al aprobar una acción, se enviarán notificaciones al responsable y personal adicional
                          </li>
                        </ul>
                      </div>
                      <div>
                        <mat-checkbox *ngIf="actionsNotApproved" (change)="$event ? masterToggle() : null"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
                        <span [ngStyle]="{'color':actionsNotApproved ? 'lightslategray' : 'white'}">
                          Seleccionar todo
                        </span>
                      </mat-checkbox>
                      </div>
                    </div>
                    <ng-container *ngFor="let row of dataSourceRedosActionsList.data; let i = index">
                      <mat-toolbar style="background: #333333">
                        <span class="ms-font-roboto w3-margin-right" style="padding: 0px 12px; color:white; background: rgba(255,255,255,0.2); font-size: 0.7em">{{i+1}}</span>
                        <div>
                          <mat-checkbox *ngIf="!row['approved']" (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null"
                          [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)">
                            <span [ngStyle]="{'color':!row['approved'] ? 'lightslategray' : 'white'}" style="font-size:0.7em">
                              Seleccionar para aprobar
                            </span>
                          </mat-checkbox>
                        </div>
                        <span class="ms-fill"></span>
                        <button mat-icon-button matTooltip="Borrar acción propuesta"
                          (click)="deleteAction(row, document)" style="color:white" [disabled]="!isTechnician">
                          <mat-icon>delete</mat-icon>
                        </button><br>
                      </mat-toolbar>
                      
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Acción</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{row['action']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Estado (Acción)</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small ms-chip" [ngClass]="{'w3-green':row['approved'], 'w3-amber':!row['approved']}">{{row['approved']?'Acción aprobada':'Por aprobar'}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Responsables</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <ng-container *ngFor="let staff of row['actionResponsibles']">
                            <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                            <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                              <li class="w3-small">{{staff['jobTitle']}}</li>
                            </ul>
                          </ng-container>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Estado (Tarea)</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small ms-chip" [ngClass]="{'w3-green':row['status']==='Finalizado', 'w3-amber':row['status']==='Por confirmar', 'w3-indigo':row['status']==='Confirmado', 'w3-red':row['status']==='Rechazado'}">
                            {{row['approved']?row['status']:'***'}}
                          </span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Fecha de finalización</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <div *ngIf="row['realTerminationDate'] != 0">
                            <span>{{row['realTerminationDate'] | date : 'dd/MM/yyy'}}</span><br>
                            <span class="w3-small">{{row['realTerminationDate'] | date : 'hh:mm:ss'}}</span>
                          </div>
                          <div *ngIf="row['realTerminationDate'] === 0">
                            <span>{{'**/**/**'}}</span><br>
                            <span class="w3-small">{{'**:**:**'}}</span>
                          </div>
                        </div>
                      </div>
                      
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Validar tarea</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <button mat-raised-button color="primary" matTooltip="Validar el cumplimiento de la tarea"
                            (click)="validateAction(row, analyze)"
                            [disabled]="row['status'] != 'Finalizado' || !row['approved'] || !isQualitySupervisor"
                            *ngIf="!row['valid']">
                            <mat-icon>check_circle</mat-icon> Validar
                          </button><br>
                          <button mat-raised-button color="warn" matTooltip="Validar el cumplimiento de la tarea"
                            (click)="resetAction(row, analyze)"
                            [disabled]="row['status'] != 'Finalizado' || !row['approved'] || !isQualitySupervisor"
                            *ngIf="row['valid']">
                            <mat-icon>settings_backup_restore</mat-icon> Restaurar
                          </button><br>
                        </div>
                      </div>

                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Fotos</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <div class="ms-gallery-container">
                            <a href="{{row['finalPicture']}}" target="_blank"
                            *ngIf="row['finalPicture']; else defaultPictureAction">
                              <div style="width:150px;height:90px;padding:6px 6px">
                                <img src="{{row['finalPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                              </div>
                            </a>
                            <ng-template #defaultPictureAction>
                              <div style="width:150px;height:90px;;padding:6px 6px">
                                <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                                  class="w3-card-4">
                              </div>
                            </ng-template>
                            <a href="{{row['finalPicture2']}}" target="_blank"
                            *ngIf="row['finalPicture2']">
                              <div style="width:150px;height:90px;;padding:6px 6px">
                                <img src="{{row['finalPicture2']}}" style="max-width:100%;height:100%" class="w3-card-4">
                              </div>
                            </a>
                            <a href="{{row['finalPicture3']}}" target="_blank"
                            *ngIf="row['finalPictur3']">
                              <div style="width:150px;height:90px;;padding:6px 6px">
                                <img src="{{row['finalPictur3']}}" style="max-width:100%;height:100%" class="w3-card-4">
                              </div>
                            </a>
                          </div>
                          
                        </div>
                      </div>

                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Archivo</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <a href="{{row['finalArchive']}}" target="_blank"
                            *ngIf="row['finalArchive']; else defaultPictureAction">
                            PDF
                          </a>
                          <ng-template #defaultPictureAction>
                            ***
                          </ng-template>
                          <a href="{{row['finalArchive2']}}" target="_blank"
                            *ngIf="row['finalArchive2']">
                            PDF
                          </a>
                          <a href="{{row['finalArchive3']}}" target="_blank"
                            *ngIf="row['finalArchive3']">
                            PDF
                          </a>
                        </div>
                      </div>

                    </ng-container>
                    <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em; background: #191919">
                      <p class="w3-margin-bottom"> </p>
                      <button mat-raised-button color="primary" class="w3-margin-right w3-margin-bottom w3-text-white" [matTooltip]="allValidated?'Solicitar cierre de documento':'Necesita que todas las tareas esten validadas para poder hacer una solicitud de cierre'"
                        (click)="requestClosing(analyze)" [disabled]="!allValidated || !isQualitySupervisor">
                        <mat-icon class="example-icon">forward</mat-icon> Solicitar cierre
                      </button>
                      <div>
                        <ul style="margin-top:0.5em">
                          <li class="ms-color-wt w3-small">
                            Se enviarán notificaciones a todos los responsables para que confirmen el cierre del rehacer
                          </li>
                          <li class="ms-color-wt w3-small">
                            Después de que todos los responsables hayan confirmado, se habilitará el botón de cierre y pasará a la lista de cerrados
                          </li>
                        </ul>
                      </div>
                    </div>
                  </mat-tab>

                </mat-tab-group>
                <mat-toolbar>
                  <span class="ms-fill"></span>
                  <button mat-icon-button matTooltip="Cerrar" (click)="toggleCardActions(i)">
                    <mat-icon>keyboard_arrow_up</mat-icon>
                  </button>
                </mat-toolbar>
              </div>


            </ng-container>
          </div>
        </div>
      </ng-template>
    </mat-tab>

    <mat-tab label="Cierre">
      <ng-template mat-tab-label>
        <span [matBadge]="dbs.qualityRedosClosing.length" matBadgeColor="warn"
        [matBadgeHidden]="dbs.qualityRedosClosing.length === 0" matBadgeOverlap="false">Cierre</span>
      </ng-template>
      <ng-template matTabContent>
          <div class="w3-padding" style="overflow-y:hidden">
            <h2 class="ms-font-rubik ms-color-2b" style="font-size:1.2em">Acciones</h2>
  
            <mat-form-field class="w3-margin-right">
              <input matInput [matDatepicker]="dateFilter" [formControl]="monthFormControl">
              <mat-datepicker-toggle matSuffix [for]="dateFilter"></mat-datepicker-toggle>
              <mat-datepicker #dateFilter startView='year' (monthSelected)="setMonthOfView($event, dateFilter)"
                disabled="false"></mat-datepicker>
              <mat-hint>
                <strong>Filtrar contenido por mes y año</strong>
              </mat-hint>
            </mat-form-field>
  
            <div style="display:flex">
              <h2 class="ms-font-rubik ms-color-2b w3-margin-right" style="font-size:1.3em;">{{currentMonth}}</h2>
              <button mat-button disabled="true" class="ms-color-2b">
                <mat-icon>assignment_turned_in</mat-icon> {{dbs.qualityRedosClosing.length | number: '2.0'}} Documentos
              </button>
            </div>
  
            <div *ngFor="let document of dbs.currentDataQualityRedosClosing | async; let i = index"
              class="w3-hide-small mat-elevation-z8 w3-round-large">
              <div [@openClosePanel]="isOpenActions[i] ? 'openPanel': 'closedPanel'"
                class="w3-block w3-round-large w3-margin-top w3-white w3-hover-shadow w3-hover-lightgray"
                style="z-index:1; position:relative" (click)="togglePanelActions(i, document)">
  
                <div class="w3-row w3-border-bottom w3-border-lightgray ms-font-roboto ms-color-bt">
                  <div class="w3-col m2 w3-padding-large">
                    <span style="font-weight:600">N°</span><br>
                    <span>{{i+1 | number : '2.'}}</span>
                  </div>
                  <div class="w3-col m2 w3-padding-large">
                    <span style="font-weight:600">Fecha</span><br>
                    <span>{{document['regDate'] | date: 'dd/MM/yyyy'}}</span>
                  </div>
                  <div class="w3-col m2 w3-padding-large">
                    <span style="font-weight:600">OT</span><br>
                    <span [ngClass]="{'w3-green w3-round-large':document['stage']==='Finalizado'}" style="padding:0.3em">{{document['OT']}}</span>
                  </div>
                  <div class="w3-col m2 w3-padding-large">
                    <span style="font-weight:600">Área</span><br>
                    <span>{{document['area']['name']}}</span>
                  </div>
                  <div class="w3-col m4 w3-padding-large">
                    <span style="font-weight:600">Descripción</span><br>
                    <span style="font-size:14px">{{document['description']}}</span>
                  </div>
                </div>
              </div>
  
              <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" class="w3-amber"
                style="overflow:auto">
                <table mat-table [dataSource]="dataSourceRedosActionsPanel" matSort style="width:100%">
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="redoType">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Tipo de Rehacer
                    </th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['redoType']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="component">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Componente</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['component']}}
                    </td>
                  </ng-container>
  
                  <!-- <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="OTSegment">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">OT / Segmento
                      Rehacer</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['OTSegment']}}
                    </td>
                  </ng-container> -->
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="customer">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Cliente</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['customer']['fullName']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="repairType">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Tipo de
                      reparación</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['repairType']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="hours">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Horas</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['hours']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="failureMode">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Modo de Falla
                    </th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['failureMode']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="rootCause">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Causa raíz</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['rootCause']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="involvedAreas">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Áreas
                      responsables</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <ng-container *ngFor="let area of row['involvedAreas']">
                        <span class="w3-small" style="font-weight:500">{{area['name']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">Sup.: {{area['supervisor']['displayName']}}</li>
                        </ul>
                      </ng-container>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo"
                    matColumnDef="responsibleStaff">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Personal
                      responsable</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <ng-container *ngFor="let staff of row['responsibleStaff']">
                        <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">Sup.: {{staff['jobTitle']}}</li>
                        </ul>
                      </ng-container>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="pictures">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fotos</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <a target="_blank" (click)="openPictures(row)"
                        *ngIf="row['initialPicture']; else defaultPictureTable1">
                        <div class="w3-display-container" style="width:200px;height:120px;padding:6px 6px">
                          <img src="{{row['initialPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                          <div class="w3-display-middle w3-round-large"
                            style="background: rgba(0,0,0,0.7);padding:0.5em 0.5em;">
                            <span style="color:white; font-size:2em; font-weight:600">
                              <mat-icon style="vertical-align:middle">add</mat-icon> {{row['pictureCounter']}}
                            </span>
                          </div>
                        </div>
                      </a>
                      <ng-template #defaultPictureTable1>
                        <div style="width:200px;height:120px;padding:6px 6px">
                          <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                            class="w3-card-4">
                        </div>
                      </ng-template>
                    </td>
                  </ng-container>
  
  
                  <tr mat-header-row *matHeaderRowDef="displayedColumnsAnalyze; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumnsAnalyze;"></tr>
  
                </table>
              </div>
  
              <div [@openCloseToolbar]="isOpenActions[i] ? 'openToolbar': 'closedToolbar'" style="background:#191919">
                <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em">
                  <button mat-raised-button color="primary" class="w3-margin-right w3-text-white" matTooltip="Agregar acciones"
                    (click)="addActions(document)" [disabled]="document['stage'] === 'Cierre' || document['stage'] === 'Finalizado'">
                    <mat-icon class="example-icon">add_circle</mat-icon> Proponer acciones
                  </button>
                  <button mat-raised-button color="primary" class="w3-margin-right w3-text-white" matTooltip=""
                    (click)="approveActions(document)" [disabled]="this.selection.selected.length === 0 || document['stage'] === 'cierre'">
                    <mat-icon>check_circle</mat-icon> Aprobar acciones
                  </button>
                  <div>
                    <ul style="margin-top:0.5em">
                      <li class="ms-color-wt w3-small">
                        Solo serán aprobadas las acciones seleccionadas (Este proceso no puede ser revertido)
                      </li>
                      <li class="ms-color-wt w3-small">
                        Al aprobar una acción, se enviarán notificaciones al responsable y personal adicional
                      </li>
                    </ul>
                  </div>
                </div>
  
              </div>
  
              <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" style="overflow:auto">
                <table mat-table [dataSource]="dataSourceRedosActionsList" matSort style="width:100%">
  
                  <!-- Checkbox Column -->
                  <ng-container matColumnDef="select">
                    <th mat-header-cell *matHeaderCellDef
                        style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">
                      <mat-checkbox *ngIf="actionsNotApproved" (change)="$event ? masterToggle() : null"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
                      </mat-checkbox>
                    </th>
                    <td mat-cell *matCellDef="let row"
                        style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <mat-checkbox *ngIf="!row['approved']" (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null"
                        [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)">
                      </mat-checkbox>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="index">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">N°
                    </th>
                    <td mat-cell *matCellDef="let row; let i = index" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{i+1}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="action">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Acción</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['action']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="approved">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Estado (Acción)</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <span class="ms-chip" [ngClass]="{'w3-green':row['approved'], 'w3-amber':!row['approved']}">{{row['approved']?'Acción aprobada':'Por aprobar'}}</span>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="responsibles">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Responsables</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <ng-container *ngFor="let staff of row['actionResponsibles']">
                        <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                        <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                          <li class="w3-small">{{staff['jobTitle']}}</li>
                        </ul>
                      </ng-container>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="finalPicture">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Foto final</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <div class="ms-gallery-container">
                        <a href="{{row['finalPicture']}}" target="_blank"
                        *ngIf="row['finalPicture']; else defaultPictureAction">
                          <div style="width:200px;height:120px;padding:6px 6px">
                            <img src="{{row['finalPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                          </div>
                        </a>
                        <ng-template #defaultPictureAction>
                          <div style="width:200px;height:120px;padding:6px 6px">
                            <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                              class="w3-card-4">
                          </div>
                        </ng-template>
                        <a href="{{row['finalPicture2']}}" target="_blank"
                        *ngIf="row['finalPicture2']">
                          <div style="width:200px;height:120px;padding:6px 6px">
                            <img src="{{row['finalPicture2']}}" style="max-width:100%;height:100%" class="w3-card-4">
                          </div>
                        </a>
                        <a href="{{row['finalPicture3']}}" target="_blank"
                        *ngIf="row['finalPictur3']">
                          <div style="width:200px;height:120px;padding:6px 6px">
                            <img src="{{row['finalPictur3']}}" style="max-width:100%;height:100%" class="w3-card-4">
                          </div>
                        </a>
                      </div>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Estado (Tarea)</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <span class="ms-chip" [ngClass]="{'w3-green':row['status']==='Finalizado', 'w3-amber':row['status']==='Por confirmar', 'w3-indigo':row['status']==='Confirmado', 'w3-red':row['status']==='Rechazado'}">
                        {{row['approved']?row['status']:'***'}}
                      </span>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="realTerminationDate">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fecha de finalización</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <div *ngIf="row['realTerminationDate'] != 0">
                        <span>{{row['realTerminationDate'] | date : 'dd/MM/yyy'}}</span><br>
                        <span class="w3-small">{{row['realTerminationDate'] | date : 'hh:mm:ss'}}</span>
                      </div>
                      <div *ngIf="row['realTerminationDate'] === 0">
                        <span>{{'**/**/**'}}</span><br>
                        <span class="w3-small">{{'**:**:**'}}</span>
                      </div>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="finalArchive">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Archivo</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <a href="{{row['finalArchive']}}" target="_blank"
                      *ngIf="row['finalArchive']; else defaultPictureAction">
                        PDF
                      </a>
                      <ng-template #defaultPictureAction>
                        ***
                      </ng-template>
                      <a href="{{row['finalArchive2']}}" target="_blank"
                        *ngIf="row['finalArchive2']">
                        PDF
                      </a>
                      <a href="{{row['finalArchive3']}}" target="_blank"
                        *ngIf="row['finalArchive3']">
                        PDF
                      </a>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="valid">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Validar tarea</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <button mat-raised-button color="primary" matTooltip="Validar el cumplimiento de la tarea"
                        (click)="validateAction(row, document)"
                        [disabled]="row['status'] != 'Finalizado' || !row['approved'] || !isQualitySupervisor"
                        *ngIf="!row['valid']">
                        <mat-icon>check_circle</mat-icon> Validar
                      </button><br>
                      <button mat-raised-button color="warn" matTooltip="Validar el cumplimiento de la tarea"
                        (click)="resetAction(row, document)"
                        [disabled]="row['status'] != 'Finalizado' || !row['approved']  || document['stage'] === 'Cierre' || document['stage'] === 'Finalizado' || !isQualitySupervisor"
                        *ngIf="row['valid']">
                        <mat-icon>settings_backup_restore</mat-icon> Restaurar tarea
                      </button><br>
                    </td>
                  </ng-container>
                  
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="delete">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Borrar</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <button mat-icon-button color="warn" matTooltip="Borrar acción propuesta"
                        (click)="deleteAction(row, document)" [disabled]="!isTechnician">
                        <mat-icon>delete</mat-icon>
                      </button><br>
                    </td>
                  </ng-container>
  
  
                  <tr mat-header-row *matHeaderRowDef="displayedColumnsActionsList; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumnsActionsList;"></tr>
  
                </table>
              </div>
  
              <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" style="background:#191919">
                <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em">

                  <p class="ms-font-poppins ms-color-wt" style="font-weight:bold">Lista de firmas</p>
                  
                </div>
              </div>
  
              <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" style="overflow:auto">
                <table mat-table [dataSource]="dataSourceRedosClosingSignList" matSort style="width:100%">
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="index">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">N°
                    </th>
                    <td mat-cell *matCellDef="let row; let i = index" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{i+1}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="user">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Usuario</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      {{row['displayName']}}
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="sign">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Firmas</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <span class="ms-chip w3-margin-bottom" [ngClass]="{'w3-green':row['sign'], 'w3-amber':!row['sign']}">{{row['sign']?'Confirmado':'Por confirmar'}}</span>
                    </td>
                  </ng-container>
  
                  <ng-container class="mat-elevation-z8 w3-border-bottom w3-border-indigo" matColumnDef="resend">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                      style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Reenviar solicitud</th>
                    <td mat-cell *matCellDef="let row" class="w3-small"
                      style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                      <button mat-raised-button color="primary" matTooltip="Reenviar notificación de confirmación"
                        (click)="resendRequest(row, document)" class="w3-margin-bottom">
                        <mat-icon>send</mat-icon> Reenviar
                      </button>
                    </td>
                  </ng-container>
  
                  <tr mat-header-row *matHeaderRowDef="displayedColumnsClosingSignList; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumnsClosingSignList;"></tr>
  
                </table>
              </div>

              <div [@openCloseTable]="isOpenActions[i] ? 'openTable': 'closedTable'" style="background:#191919">
                <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em">
                  <p class="w3-margin-bottom"> </p>
                  <button mat-raised-button color="primary" class="w3-margin-right w3-margin-bottom w3-text-white" matTooltip="Cerrar rehacer" (click)="closeRedo(document)"
                    *ngIf="document['stage'] === 'Cierre'" [disabled]="!isQualitySupervisor || !allSigned">
                    <mat-icon class="example-icon">archive</mat-icon> Cerrar rehacer
                  </button>
                  <a [href]="document['finalReport']" *ngIf="document['stage'] === 'Finalizado' && document['finalReport']" target="_blank">
                    <button mat-raised-button color="primary" class="w3-margin-right w3-margin-bottom w3-text-white" matTooltip="Descargar informe final"
                      *ngIf="document['stage'] === 'Finalizado' && document['finalReport']">
                      <mat-icon class="example-icon">cloud_download</mat-icon> Descargar informe final
                    </button>
                  </a>
                </div>
              </div>
  
  
            </div>
  
            <!-- MOBIL VERSION CLOSING-->
            <div class="w3-hide-large w3-hide-medium w3-margin-top">
              <ng-container *ngFor="let analyze of dbs.currentDataQualityRedosClosing | async; let i = index">
                <div [@openClosePanelMobile]="isOpenActions[i] ? 'openPanelMobile': 'closedPanelMobile'"
                  (click)="togglePanelActions(i, analyze)"
                  class="mat-elevation-z8 ms-hero-image w3-display-container w3-round-large"
                  [ngStyle]="{'background-image': analyze['initialPicture'] ? ('url(' + analyze['initialPicture'] + ')') : 'url(../../../assets/images/no-image-mobile.jpeg)'}">
  
                  <div class="w3-display-bottomleft w3-padding w3-round-large"
                    style="background:rgba(0,0,0,0.2); width:100%; height:100%">
                    <div style="display:flex">
                      <p style="font-weight:600; color:white; margin: 0.5em 0.1em">
                        <span class="w3-round-large"
                          style="background: rgba(255,255,255,0.2); padding:4px 12px; margin-right:8px">{{i +1}}</span>
                        {{analyze['OT']}}
                      </p>
                      <span class="ms-fill"></span>
                      <button mat-icon-button class="w3-text-white" matTooltip="Borrar rehacer"
                        (click)="deleteActions(analyze)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
  
                    <mat-divider class="w3-white" style="margin:0.5em 0em"></mat-divider>
                    <p style="font-weight:400; color:white; margin: 0px 0.1em">
                      {{analyze['area']['name']}}
                    </p>
                    <p style="font-weight:400; color:white; margin: 0px 0.1em">
                      {{analyze['component']}}
                    </p>
  
                    <div style="display:flex; justify-content: space-between">
                      <span style="padding:8px 0px; font-size:0.9em; color: white" matTooltip="Fecha de reporte"
                        *ngIf="analyze['regDate'] > 0">
                        {{(analyze['regDate']) | date: 'dd/MM/yyyy'}}</span>
                      <span class="ms-fill"></span>
                      <span class="w3-padding w3-round-large w3-center" style="font-size:0.9em; font-weight:500"
                        [ngClass]="{'w3-red':analyze['status'] === 'Rechazado', 'w3-green':analyze['status'] === 'Confirmado', 'w3-amber':analyze['status'] === 'Por confirmar'}"
                        matTooltip="Fecha de análisis">
                        <span>Acciones</span><br>
                        <span>{{analyze['actionsDate'] | date: 'dd/MM/yyyy' }}</span>
  
                      </span>
                    </div>
                  </div>
  
                </div>
  
                <div [@openCloseContent]="isOpenActions[i] ? 'openContent': 'closedContent'" class="mat-elevation-z8"
                  style="min-height:560px">
                  <mat-tab-group animation="500ms" [selectedIndex]="currentActionsTab.value"
                    (selectedIndexChange)="currentActionsTab.setValue($event)">
  
                    <mat-tab label="Reporte">
                      <mat-toolbar style="background: #333333">
                        <span class="ms-font-raleway ms-color-wt" style="font-weight:500; margin-bottom:0.5em; font-size:1.5em; width:100%">Reporte</span>
                        <span class="ms-fill"></span>
                      </mat-toolbar>
  
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Fecha</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span>{{analyze['regDate'] | date : 'dd/MM/yyy'}}</span><br>
                          <span class="w3-small">{{analyze['regDate'] | date : 'hh:mm:ss'}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Creado por</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small" style="font-weight:500">{{analyze['createdBy']['displayName']}}</span>
                          <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                            <li class="w3-small">Area: {{analyze['createdBy']['area']['name']}}</li>
                          </ul>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">OT</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['OT']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Área</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small" style="font-weight:500">{{analyze['area']['name']}}</span>
                          <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                            <li class="w3-small">Sup.: {{analyze['area']['supervisor']['displayName']}}</li>
                          </ul>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Descripción</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['description']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Componente</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['component']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Estado</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['status']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Imagen inicial</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <a class="w3-medium" target="_blank" [href]="analyze['initialPicture']"
                            *ngIf="analyze['initialPicture']; else noImageLink">Ver imagen</a>
                          <ng-template #noImageLink>
                            <span class="w3-small w3-text-gray">No disponible</span>
                          </ng-template>
                        </div>
                      </div>
                    </mat-tab>
  
                    <mat-tab label="Análisis">
                      <mat-toolbar style="background: #333333">
                        <span class="ms-font-raleway ms-color-wt" style="font-weight:500; margin-bottom:0.5em; font-size:1.5em; width:100%">Análisis</span>
                        <span class="ms-fill"></span>
                      </mat-toolbar>
  
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Tipo de rehacer</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span>{{analyze['redoType']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                        <div class="w3-col s6 ms-header-mobile">Componente</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['component']}}</span>
                        </div>
                      </div>
                      <!-- <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">OT / Segmento de rehacer</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['OTSegment']}}</span>
                        </div>
                      </div> -->
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Cliente</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['customer']['fullName']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Tipo de reparación</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['repairType']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Horas</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['hours']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Modo de falla</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['failureMode']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Causa raíz</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <span class="w3-small">{{analyze['rootCause']}}</span>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Áreas responsables</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <ng-container *ngFor="let area of analyze['involvedAreas']">
                            <span class="w3-small" style="font-weight:500">{{area['name']}}</span>
                            <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                              <li class="w3-small">Sup.: {{area['supervisor']['displayName']}}</li>
                            </ul>
                          </ng-container>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Personal responsable</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <ng-container *ngFor="let staff of analyze['responsibleStaff']">
                            <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                            <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                              <li class="w3-small">Sup.: {{staff['jobTitle']}}</li>
                            </ul>
                          </ng-container>
                        </div>
                      </div>
                      <div class="w3-row w3-border-bottom w3-border-lightgray">
                        <div class="w3-col s6 ms-header-mobile">Fotos</div>
                        <div class="w3-col s6" style="padding: 0.5em 0.5em">
                          <a target="_blank" (click)="openPictures(analyze)"
                            *ngIf="analyze['initialPicture']; else defaultPictureTable1">
                            <div class="w3-display-container" style="width:150px;height:90px;padding:6px 6px">
                              <img src="{{analyze['initialPicture']}}" style="max-width:100%;height:100%"
                                class="w3-card-4">
                              <div class="w3-display-middle w3-round-large"
                                style="background: rgba(0,0,0,0.7);padding:0.5em 0.5em;">
                                <span style="color:white; font-size:2em; font-weight:600">
                                  <mat-icon style="vertical-align:middle">add</mat-icon> {{analyze['pictureCounter']}}
                                </span>
                              </div>
                            </div>
                          </a>
                          <ng-template #defaultPictureTable1>
                            <div style="width:150px;height:90px;padding:6px 6px">
                              <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                                class="w3-card-4">
                            </div>
                          </ng-template>
                        </div>
                      </div>
  
                    </mat-tab>
  
                    <mat-tab label="Acciones">
                      <ng-container *ngFor="let row of dataSourceRedosActionsList.data; let i = index">
                        <mat-toolbar style="background: #333333">
                          <span class="ms-font-roboto w3-margin-right" style="padding: 0px 12px; color:white; background: rgba(255,255,255,0.2); font-size: 0.7em">{{i+1}}</span>
                          <div>
                            <mat-checkbox *ngIf="!row['approved']" (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null"
                            [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)">
                              <span [ngStyle]="{'color':!row['approved'] ? 'lightslategray' : 'white'}" style="font-size:0.7em">
                                Seleccionar para aprobar
                              </span>
                            </mat-checkbox>
                          </div>
                          <span class="ms-fill"></span>
                          <button mat-icon-button matTooltip="Borrar acción propuesta"
                            (click)="deleteAction(row, document)" style="color:white" [disabled]="!isTechnician">
                            <mat-icon>delete</mat-icon>
                          </button><br>
                        </mat-toolbar>
                        
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Acción</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <span class="w3-small">{{row['action']}}</span>
                          </div>
                        </div>
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Estado (Acción)</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <span class="w3-small ms-chip" [ngClass]="{'w3-green':row['approved'], 'w3-amber':!row['approved']}">{{row['approved']?'Acción aprobada':'Por aprobar'}}</span>
                          </div>
                        </div>
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Responsables</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <ng-container *ngFor="let staff of row['actionResponsibles']">
                              <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                              <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                                <li class="w3-small">{{staff['jobTitle']}}</li>
                              </ul>
                            </ng-container>
                          </div>
                        </div>
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Estado (Tarea)</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <span class="w3-small ms-chip" [ngClass]="{'w3-green':row['status']==='Finalizado', 'w3-amber':row['status']==='Por confirmar', 'w3-indigo':row['status']==='Confirmado', 'w3-red':row['status']==='Rechazado'}">
                              {{row['approved']?row['status']:'***'}}
                            </span>
                          </div>
                        </div>
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Fecha de finalización</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <div *ngIf="row['realTerminationDate'] != 0">
                              <span>{{row['realTerminationDate'] | date : 'dd/MM/yyy'}}</span><br>
                              <span class="w3-small">{{row['realTerminationDate'] | date : 'hh:mm:ss'}}</span>
                            </div>
                            <div *ngIf="row['realTerminationDate'] === 0">
                              <span>{{'**/**/**'}}</span><br>
                              <span class="w3-small">{{'**:**:**'}}</span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Validar tarea</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <button mat-raised-button color="primary" matTooltip="Validar el cumplimiento de la tarea"
                              (click)="validateAction(row, analyze)"
                              [disabled]="row['status'] != 'Finalizado' || !row['approved'] || !isQualitySupervisor"
                              *ngIf="!row['valid']">
                              <mat-icon>check_circle</mat-icon> Validar
                            </button><br>
                            <button mat-raised-button color="warn" matTooltip="Validar el cumplimiento de la tarea"
                              (click)="resetAction(row, analyze)"
                              [disabled]="row['status'] != 'Finalizado' || !row['approved'] || row['stage'] === 'Cierre' || !isQualitySupervisor"
                              *ngIf="row['valid']">
                              <mat-icon>settings_backup_restore</mat-icon> Restaurar
                            </button><br>
                          </div>
                        </div>
  
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Fotos</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <div class="ms-gallery-container">
                              <a href="{{row['finalPicture']}}" target="_blank"
                              *ngIf="row['finalPicture']; else defaultPictureAction">
                                <div style="width:150px;height:90px;padding:6px 6px">
                                  <img src="{{row['finalPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                                </div>
                              </a>
                              <ng-template #defaultPictureAction>
                                <div style="width:150px;height:90px;;padding:6px 6px">
                                  <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                                    class="w3-card-4">
                                </div>
                              </ng-template>
                              <a href="{{row['finalPicture2']}}" target="_blank"
                              *ngIf="row['finalPicture2']">
                                <div style="width:150px;height:90px;;padding:6px 6px">
                                  <img src="{{row['finalPicture2']}}" style="max-width:100%;height:100%" class="w3-card-4">
                                </div>
                              </a>
                              <a href="{{row['finalPicture3']}}" target="_blank"
                              *ngIf="row['finalPictur3']">
                                <div style="width:150px;height:90px;;padding:6px 6px">
                                  <img src="{{row['finalPictur3']}}" style="max-width:100%;height:100%" class="w3-card-4">
                                </div>
                              </a>
                            </div>
                            
                          </div>
                        </div>
  
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Archivo</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <a href="{{row['finalArchive']}}" target="_blank"
                              *ngIf="row['finalArchive']; else defaultPictureAction">
                              PDF
                            </a>
                            <ng-template #defaultPictureAction>
                              ***
                            </ng-template>
                            <a href="{{row['finalArchive2']}}" target="_blank"
                              *ngIf="row['finalArchive2']">
                              PDF
                            </a>
                            <a href="{{row['finalArchive3']}}" target="_blank"
                              *ngIf="row['finalArchive3']">
                              PDF
                            </a>
                          </div>
                        </div>
  
                      </ng-container>
                    </mat-tab>

                    <mat-tab label="Cierre">
                      <div style=" display:flex; padding:0.5em 1em; background:#191919">
                        <p class="ms-font-poppins ms-color-wt" style="font-weight:bold; font-size:1.2em">Lista de firmas</p>
                      </div>

                      <ng-container *ngFor="let row of dataSourceRedosClosingSignList.data; let i = index">
                        <mat-toolbar style="background: #333333">
                          <span class="ms-font-roboto w3-margin-right" style="padding: 0px 12px; color:white; background: rgba(255,255,255,0.2); font-size: 0.7em">{{i+1}}</span>
                          <span class="ms-fill"></span>
                        </mat-toolbar>
                        
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Usuario</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <span class="w3-small">{{row['displayName']}}</span>
                          </div>
                        </div>
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Firmas</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                              <span class="ms-chip w3-margin-bottom w3-small" [ngClass]="{'w3-green':row['sign'], 'w3-amber':!row['sign']}">{{row['sign']?'Confirmado':'Por confirmar'}}</span>
                          </div>
                        </div>
                        <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                          <div class="w3-col s6 ms-header-mobile">Reenviar solicitud</div>
                          <div class="w3-col s6" style="padding: 0.5em 0.5em">
                            <button mat-raised-button color="primary" matTooltip="Reenviar notificación de confirmación"
                            (click)="resendRequest(row, document)" class="w3-margin-bottom">
                              <mat-icon>send</mat-icon> Reenviar
                            </button>
                          </div>
                        </div>
  
                      </ng-container>

                      <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em; background: #191919">
                        <p class="w3-margin-bottom"> </p>
                        <button mat-raised-button color="primary" class="w3-margin-right w3-margin-bottom w3-text-white" matTooltip="Cerrar rehacer" (click)="closeRedo(analyze)"
                          *ngIf="analyze['stage'] === 'Cierre'" [disabled]="!isQualitySupervisor  || !allSigned">
                          <mat-icon class="example-icon">archive</mat-icon> Cerrar rehacer
                        </button>
                        <a [href]="analyze['finalReport']" *ngIf="analyze['stage'] === 'Finalizado' && document['finalReport']" target="_blank">
                          <button mat-raised-button color="primary" class="w3-margin-right w3-margin-bottom w3-text-white" matTooltip="Descargar informe final">
                            <mat-icon class="example-icon">cloud_download</mat-icon> Descargar informe final
                          </button>
                        </a>
                      </div>

                    </mat-tab>
  
                  </mat-tab-group>
                  <mat-toolbar>
                    <span class="ms-fill"></span>
                    <button mat-icon-button matTooltip="Cerrar" (click)="toggleCardActions(i)">
                      <mat-icon>keyboard_arrow_up</mat-icon>
                    </button>
                  </mat-toolbar>
                </div>
  
  
              </ng-container>
            </div>
          </div>
        </ng-template>
    </mat-tab>
  </mat-tab-group>


</div>