<div class="w3-section">
    <h1 class="ms-font-rubik ms-color-2b" style="font-size:1.5em;">
      <mat-icon style="vertical-align:middle; font-size: 30px; width:30px; height: 30px">assignment</mat-icon> Calidad - Tareas
    </h1>
    <mat-divider></mat-divider>
  
    <div class="w3-padding">
      <h2 class="ms-font-rubik ms-color-2b" style="font-size:1.2em">{{currentYear}}</h2>

      <mat-form-field class="w3-margin-right">
        <input matInput [matDatepicker]="dateFilter" [formControl]="monthFormControl">
        <mat-datepicker-toggle matSuffix [for]="dateFilter"></mat-datepicker-toggle>
        <mat-datepicker #dateFilter startView='year' (monthSelected)="setMonthOfView($event, dateFilter)"
          disabled="false"></mat-datepicker>
        <mat-hint>
          <strong>Filtrar contenido por mes y año</strong>
        </mat-hint>
      </mat-form-field>

      <div style="display:flex">
        <h2 class="ms-font-rubik ms-color-2b w3-margin-right" style="font-size:1.3em;">{{currentMonth}}</h2>
        <button mat-button disabled="true" class="ms-color-2b">
          <mat-icon>assignment_turned_in</mat-icon> {{dbs.qualityTasks.length | number: '2.0'}} Tareas
        </button>
      </div>

      <h2 class="ms-font-rubik ms-color-2b" style="font-size:1.2em">Tareas generadas por Rehaceres</h2>
      <div class="mat-elevation-z8 w3-margin-top w3-round-large w3-hide-small">
        <div class="w3-amber" style="overflow:auto">
          <table mat-table [dataSource]="dataSourceTasksByRedo" matSort style="width:100%">

            <ng-container matColumnDef="index">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">N°
              </th>
              <td mat-cell *matCellDef="let row; let i = index" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                {{i+1}}
              </td>
            </ng-container>

            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Acción</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                {{row['action']}}
              </td>
            </ng-container>

            <ng-container matColumnDef="approved">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Estado (Acción)</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                {{row['approved']?'Acción aprobada':'Por aprobar'}}
              </td>
            </ng-container>

            <ng-container matColumnDef="responsibles">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Responsable</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
              <ng-container *ngFor="let staff of row['actionResponsibles']">
                  <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                  <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                    <li class="w3-small">{{staff['jobTitle']}}</li>
                  </ul>
              </ng-container>
                
              </td>
            </ng-container>

            <ng-container matColumnDef="finalPicture">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Foto final</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                <a href="{{row['finalPicture']}}" target="_blank"
                  *ngIf="row['finalPicture']; else defaultPictureAction">
                  <div style="width:200px;height:120px;padding:6px 6px">
                    <img src="{{row['finalPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                  </div>
                </a>
                <ng-template #defaultPictureAction>
                  <div style="width:200px;height:120px;padding:6px 6px">
                    <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                      class="w3-card-4">
                  </div>
                </ng-template>
              </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Estado (Tarea)</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                  <span class="ms-chip" [ngClass]="{'w3-green':row['status']==='Finalizado', 'w3-amber':row['status']==='Por confirmar', 'w3-indigo':row['status']==='Confirmado', 'w3-red':row['status']==='Rechazado'}">
                    {{row['approved']?row['status']:'***'}}
                  </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="realTerminationDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Fecha de finalización</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                <div *ngIf="row['realTerminationDate'] != 0">
                  <span>{{row['realTerminationDate'] | date : 'dd/MM/yyy'}}</span><br>
                  <span class="w3-small">{{row['realTerminationDate'] | date : 'hh:mm:ss'}}</span>
                </div>
                <div *ngIf="row['realTerminationDate'] === 0">
                  <span>{{'**/**/**'}}</span><br>
                  <span class="w3-small">{{'**:**:**'}}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="finalArchive">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Archivo</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                  <a href="{{row['finalArchive']}}" target="_blank"
                    *ngIf="row['finalArchive']; else defaultPictureAction">
                    PDF
                  </a>
                  <ng-template #defaultPictureAction>
                    ***
                  </ng-template>
              </td>
            </ng-container>
            

            <ng-container matColumnDef="finalize">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                style="padding:0px 1em 0px 1em; border-left:1px solid lightgrey">Acciones</th>
              <td mat-cell *matCellDef="let row" class="w3-small"
                style="color:#2b2b2b; padding:1em 1em 0px 1em; border-left:1px solid lightgrey">
                <button mat-raised-button color="primary" matTooltip="Finalizar tarea"
                  (click)="finalizeTask(row)" [disabled]="row['status'] === 'Finalizado'">
                  <mat-icon>check_circle</mat-icon> Finalizar
                </button><br>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="displayedColumnsTasksByRedo; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsTasksByRedo;"></tr>

          </table>
        </div>
        <mat-paginator class="w3-round-large" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
      </div>

      <!-- MOBIL VERSION ACTIONS-->
      <!-- <div class="w3-hide-large w3-hide-medium w3-margin-top">
        <ng-container *ngFor="let analyze of dbs.currentDataQualityRedosActions | async; let i = index">
          <div [@openClosePanelMobile]="isOpenActions[i] ? 'openPanelMobile': 'closedPanelMobile'"
            (click)="togglePanelActions(i, analyze)"
            class="mat-elevation-z8 ms-hero-image w3-display-container w3-round-large"
            [ngStyle]="{'background-image': analyze['initialPicture'] ? ('url(' + analyze['initialPicture'] + ')') : 'url(../../../assets/images/no-image-mobile.jpeg)'}">

            <div class="w3-display-bottomleft w3-padding w3-round-large"
              style="background:rgba(0,0,0,0.2); width:100%; height:100%">
              <div style="display:flex">
                <p style="font-weight:600; color:white; margin: 0.5em 0.1em">
                  <span class="w3-round-large"
                    style="background: rgba(255,255,255,0.2); padding:4px 12px; margin-right:8px">{{i +1}}</span>
                  {{analyze['OT']}}
                </p>
                <span class="ms-fill"></span>
                <button mat-icon-button class="w3-text-white" matTooltip="Proponer acciones"
                  (click)="nextStageClose(analyze)"
                  [disabled]="analyze['stage'] != 'Acciones' || analyze['status'] === 'Por confirmar'">
                  <mat-icon>next_week</mat-icon>
                </button>
                <button mat-icon-button class="w3-text-white" matTooltip="Borrar rehacer"
                  (click)="deleteActions(analyze)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <mat-divider class="w3-white" style="margin:0.5em 0em"></mat-divider>
              <p style="font-weight:400; color:white; margin: 0px 0.1em">
                {{analyze['area']['name']}}
              </p>
              <p style="font-weight:400; color:white; margin: 0px 0.1em">
                {{analyze['component']}}
              </p>

              <div style="display:flex; justify-content: space-between">
                <span style="padding:8px 0px; font-size:0.9em; color: white" matTooltip="Fecha de reporte"
                  *ngIf="analyze['regDate'] > 0">
                  {{(analyze['regDate']) | date: 'dd/MM/yyyy'}}</span>
                <span class="ms-fill"></span>
                <span class="w3-padding w3-round-large w3-center" style="font-size:0.9em; font-weight:500"
                  [ngClass]="{'w3-red':analyze['status'] === 'Rechazado', 'w3-green':analyze['status'] === 'Confirmado', 'w3-amber':analyze['status'] === 'Por confirmar'}"
                  matTooltip="Fecha de análisis">
                  <span>Acciones</span><br>
                  <span>{{analyze['actionsDate'] | date: 'dd/MM/yyyy' }}</span>

                </span>
              </div>
            </div>

          </div>

          <div [@openCloseContent]="isOpenActions[i] ? 'openContent': 'closedContent'" class="mat-elevation-z8"
            style="min-height:560px">
            
            <div style=" display:flex; flex-wrap:wrap; align-items:center; padding:0.5em 1em; background:#191919">
              <span class="ms-font-raleway ms-color-wt w3-margin-bottom" style="font-weight:500; margin-bottom:0.5em; font-size:1.5em; width:100%">Acciones</span><br>  
              <button mat-raised-button color="primary" class="w3-margin-right; w3-margin-bottom" matTooltip="Agregar acciones"
                (click)="addActions(analyze)">
                <mat-icon class="example-icon">add_circle</mat-icon> Proponer acciones
              </button>
              <button mat-raised-button color="primary" class="w3-margin-right w3-text-white" matTooltip="Aprovar acciones seleccionadas"
                (click)="approveActions(analyze)" [ngStyle]="{'color:lightslategray':this.selection.selected.length === 0}" [disabled]="this.selection.selected.length === 0">
                <mat-icon>check_circle</mat-icon> Aprobar acciones
              </button>
              <div>
                <ul style="margin-top:0.5em">
                  <li class="ms-color-wt w3-small">
                    Solo serán aprobadas las acciones seleccionadas (Este proceso no puede ser revertido)
                  </li>
                  <li class="ms-color-wt w3-small">
                    Al aprobar una acción, se enviarán notificaciones al responsable y personal adicional
                  </li>
                </ul>
              </div>
              <div>
                <mat-checkbox *ngIf="actionsNotApproved" (change)="$event ? masterToggle() : null"
                [checked]="selection.hasValue() && isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
                <span [ngStyle]="{'color':actionsNotApproved ? 'lightslategray' : 'white'}">
                  Seleccionar todo
                </span>
              </mat-checkbox>
              </div>
            </div>
            <ng-container *ngFor="let row of dataSourceRedosActionsList.data; let i = index">
              <mat-toolbar style="background: #333333">
                <span class="ms-font-roboto w3-margin-right" style="padding: 0px 12px; color:white; background: rgba(255,255,255,0.2); font-size: 0.7em">{{i+1}}</span>
                <div>
                  <mat-checkbox *ngIf="!row['approved']" (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null"
                  [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)">
                    <span [ngStyle]="{'color':!row['approved'] ? 'lightslategray' : 'white'}" style="font-size:0.7em">
                      Seleccionar para aprobar
                    </span>
                  </mat-checkbox>
                </div>
                <span class="ms-fill"></span>
                <button mat-icon-button matTooltip="Borrar acción propuesta"
                  (click)="deleteAction(row, document)" style="color:white">
                  <mat-icon>delete</mat-icon>
                </button><br>
              </mat-toolbar>
              
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Acción</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <span class="w3-small">{{row['action']}}</span>
                </div>
              </div>
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">estado (Acción)</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <span class="w3-small">{{row['approved']?'Acción aprobada':'Por aprobar'}}</span>
                </div>
              </div>
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Responsable</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <span class="w3-small" style="font-weight:500">{{row['actionResponsible']['displayName']}}</span>
                  <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                    <li class="w3-small">{{row['actionResponsible']['jobTitle']}}</li>
                  </ul>
                </div>
              </div>
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Personal adicional</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <ng-container *ngFor="let staff of row['additionalStaff']">
                    <span class="w3-small" style="font-weight:500">{{staff['displayName']}}</span>
                    <ul style="margin-top:0px;margin-bottom:7px;padding-left:16px;">
                      <li class="w3-small">{{staff['jobTitle']}}</li>
                    </ul>
                  </ng-container>
                </div>
              </div>
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Estado (Tarea)</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <span class="w3-small">{{row['approved']?row['status']:'***'}}</span>
                </div>
              </div>
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Fecha de finalización</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <div *ngIf="row['realTerminationDate'] != 0">
                    <span>{{row['realTerminationDate'] | date : 'dd/MM/yyy'}}</span><br>
                    <span class="w3-small">{{row['realTerminationDate'] | date : 'hh:mm:ss'}}</span>
                  </div>
                  <div *ngIf="row['realTerminationDate'] === 0">
                    <span>{{'**/**/**'}}</span><br>
                    <span class="w3-small">{{'**:**:**'}}</span>
                  </div>
                </div>
              </div>
              
              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Validar tarea</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <button mat-raised-button color="primary" matTooltip="Validar el cumplimiento de la tarea"
                  (click)="validateAction(row, document)" [disabled]="row['status'] != 'Finalizado' || !row['valid']">
                    <mat-icon>check_circle</mat-icon> Validar
                  </button><br>
                </div>
              </div>

              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Archivo</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <a href="{{row['finalPicture']}}" target="_blank"
                  *ngIf="row['finalPicture']; else defaultPictureAction">
                    <div style="width:200px;height:120px;padding:6px 6px">
                      <img src="{{row['finalPicture']}}" style="max-width:100%;height:100%" class="w3-card-4">
                    </div>
                  </a>
                  <ng-template #defaultPictureAction>
                    <div style="width:200px;height:120px;padding:6px 6px">
                      <img src="../../../assets/images/no-image.png" style="max-width:100%;height:100%"
                        class="w3-card-4">
                    </div>
                  </ng-template>
                </div>
              </div>

              <div class="w3-row w3-border-bottom w3-border-lightgray w3-margin-top">
                <div class="w3-col s6 ms-header-mobile">Archivo</div>
                <div class="w3-col s6" style="padding: 0.5em 0.5em">
                  <a href="{{row['finalArchive']}}" target="_blank"
                    *ngIf="row['finalArchive']; else defaultPictureAction">
                    PDF
                  </a>
                  <ng-template #defaultPictureAction>
                    ***
                  </ng-template>
                </div>
              </div>

            </ng-container>
            <mat-toolbar>
              <span class="ms-fill"></span>
              <button mat-icon-button matTooltip="Cerrar" (click)="toggleCardActions(i)">
                <mat-icon>keyboard_arrow_up</mat-icon>
              </button>
            </mat-toolbar>
            
          </div>
        </ng-container>

      </div> -->

    </div>
  
  
  </div>